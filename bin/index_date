#!/bin/bash

if [ $# -lt 1 -o $# -gt 2 ]
then
  echo
  echo "index_date: run the catchup (delete and index) for a particular date"
  echo
  echo "USAGE:"
  echo "    index_date YYYYMMDD <optional1_logfile>"
  echo
  exit
fi


HERE=`dirname $0`
SCRIPTDIR=`realpath $HERE`
ROOTDIR=`realpath $SCRIPTDIR/..`
DATE=$1
[[ ! -z "$2" ]] && logfile=`realpath "$2"`

cd $SCRIPTDIR

#source $SCRIPTDIR/set_java_home.sh
source $SCRIPTDIR/utils.sh
export SOLR_URL=`solr_url`

# where do we keep the data?
DDIR=`data_dir`

jruby_path=`jruby_bin_dir`
export PATH=$jruby_path:$PATH
JRUBY="${jruby_path}/jruby"

delfile=`find_del_file_for_date $DATE $DDIR`
marcfile=`find_marc_file_for_date $DATE $DDIR`

if [ -f "$delfile" ] 
then
  log  "Deleting from $delfile, targeting $SOLR_URL" $logfile
  cd $ROOTDIR
  delout=`bundle exec jruby $SCRIPTDIR/delete_ids $delfile`
  log "$delout" "$logfile"
else
  log  "No Deletes: Could not find delfile '$delfile'" $logfile
fi


if [ -f "$marcfile" ] 
then
    cd $TDIR
    $SCRIPTDIR/index_file $marcfile $logfile
else
  log  "No indexing: Could not find marcfile '$marcfile'" $logfile
fi


commit
